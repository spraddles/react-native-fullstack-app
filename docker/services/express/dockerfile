FROM node:20-alpine3.21 AS builder
WORKDIR /build
COPY docker/services/express/package*.json .
RUN npm ci
COPY docker/services/express .

FROM node:20-alpine3.21
WORKDIR /app
RUN addgroup -S appgroup && adduser -S appuser -G appgroup -u 1001
COPY --from=builder --chown=appuser:appgroup /build/node_modules ./node_modules
COPY --from=builder --chown=appuser:appgroup /build .
USER appuser
EXPOSE 3000
CMD ["npm", "run", "express"]

# for diagnosing container
# CMD ["sh", "-c", "tail -F keep_alive"]